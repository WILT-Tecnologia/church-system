<form [formGroup]="financialTransactionsForm" (ngSubmit)="handleSubmit()" class="form-field-group">
  <mat-tab-group animationDuration="300ms">
    <mat-tab label="Identificação">
      <app-column [columns]="2">
        <mat-form-field appearance="fill">
          <mat-label>Igreja</mat-label>
          <input
            matInput
            [matAutocomplete]="autoChurch"
            [formControl]="searchControlChurch"
            placeholder="Selecione uma igreja"
            (focus)="showAll()"
            required
          />
          <mat-autocomplete
            #autoChurch="matAutocomplete"
            [displayWith]="displayChurch"
            (optionSelected)="onChurchSelected($event)"
          >
            @for (church of churches; track church.id) {
              <mat-option [value]="church">{{ church.name }}</mat-option>
            }
          </mat-autocomplete>
          @if (financialTransactionsForm.get('church_id')?.invalid) {
            <mat-error>{{ getErrorMessage('church_id') }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Categoria Financeira</mat-label>
          <mat-select formControlName="cat_financial_id" required>
            @for (cat of categories; track cat.id) {
              <mat-option [value]="cat.id">{{ cat.name }}</mat-option>
            }
          </mat-select>
          @if (getErrorMessage('cat_financial_id')) {
            <mat-error>{{ getErrorMessage('cat_financial_id') }}</mat-error>
          }
        </mat-form-field>
      </app-column>

      <app-column [columns]="2">
        <mat-form-field>
          <mat-label>Tipo de Transação</mat-label>
          <mat-select formControlName="entry_exit" required>
            @for (option of entryExitOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
          @if (getErrorMessage('entry_exit')) {
            <mat-error>{{ getErrorMessage('entry_exit') }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Tipo de Cliente/Fornecedor</mat-label>
          <mat-select formControlName="customer_supplier" required>
            @for (option of customerSupplierOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
          @if (getErrorMessage('customer_supplier')) {
            <mat-error>{{ getErrorMessage('customer_supplier') }}</mat-error>
          }
        </mat-form-field>
      </app-column>

      @if (financialTransactionsForm.get('customer_supplier')?.value) {
        <app-column [columns]="1">
          @if (financialTransactionsForm.get('customer_supplier')?.value === customerSupplier.MEMBRO) {
            <mat-form-field>
              <mat-label>Membro</mat-label>
              <mat-select formControlName="member_id" required>
                @for (member of members; track member.id) {
                  <mat-option [value]="member.id">{{ member.person.name }}</mat-option>
                }
              </mat-select>
              @if (getErrorMessage('member_id')) {
                <mat-error>{{ getErrorMessage('member_id') }}</mat-error>
              }
            </mat-form-field>
          }

          @if (financialTransactionsForm.get('customer_supplier')?.value === customerSupplier.FORNECEDOR) {
            <mat-form-field>
              <mat-label>Fornecedor</mat-label>
              <mat-select formControlName="supplier_id" required>
                @for (supplier of suppliers; track supplier.id) {
                  <mat-option [value]="supplier.id">{{ supplier.name }}</mat-option>
                }
              </mat-select>
              @if (getErrorMessage('supplier_id')) {
                <mat-error>{{ getErrorMessage('supplier_id') }}</mat-error>
              }
            </mat-form-field>
          }

          @if (financialTransactionsForm.get('customer_supplier')?.value === customerSupplier.PESSOA) {
            <mat-form-field>
              <mat-label>Nome da Pessoa</mat-label>
              <input matInput formControlName="person_name" required />
              @if (getErrorMessage('person_name')) {
                <mat-error>{{ getErrorMessage('person_name') }}</mat-error>
              }
            </mat-form-field>
          }
        </app-column>
      }

      <app-column [columns]="1">
        <mat-form-field>
          <mat-label>Descrição</mat-label>
          <textarea matInput formControlName="description" rows="3"></textarea>
          @if (getErrorMessage('description')) {
            <mat-error>{{ getErrorMessage('description') }}</mat-error>
          }
        </mat-form-field>
      </app-column>
    </mat-tab>

    <mat-tab label="Financeiro">
      <app-column [columns]="2">
        <mat-form-field>
          <mat-label>Valor</mat-label>
          <input
            matInput
            formControlName="amount"
            mask="separator.2"
            thousandSeparator="."
            decimalMarker=","
            prefix="R$ "
            [leadZero]="true"
            required
          />
          @if (getErrorMessage('amount')) {
            <mat-error>{{ getErrorMessage('amount') }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>Desconto</mat-label>
          <input
            matInput
            formControlName="discount"
            mask="separator.2"
            thousandSeparator="."
            decimalMarker=","
            prefix="R$ "
            [leadZero]="true"
          />
          @if (getErrorMessage('discount')) {
            <mat-error>{{ getErrorMessage('discount') }}</mat-error>
          }
        </mat-form-field>
      </app-column>

      <app-column [columns]="2">
        <mat-form-field>
          <mat-label>Valor com Desconto</mat-label>
          <input
            matInput
            formControlName="amount_discount"
            mask="separator.2"
            thousandSeparator="."
            decimalMarker=","
            prefix="R$ "
            [leadZero]="true"
          />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Data do Pagamento</mat-label>
          <input
            matInput
            type="text"
            name="payment_date"
            [matDatepicker]="payment_date"
            placeholder="dd/mm/aaaa"
            formControlName="payment_date"
            [min]="minDate"
            required
          />
          <mat-datepicker-toggle matSuffix [for]="payment_date"></mat-datepicker-toggle>
          <mat-datepicker #payment_date>
            <mat-datepicker-actions>
              @if (financialTransactionsForm.get('payment_date')?.value) {
                <button
                  matTooltip="Limpar a data"
                  mat-flat-button
                  matSuffix
                  matDatepickerToggleIcon
                  (click)="clearDate('payment_date')"
                  type="button"
                  color="warn"
                >
                  <mat-icon>close</mat-icon>
                  Limpar
                </button>
              } @else {
                <button type="button" mat-stroked-button matDatepickerCancel>Cancelar</button>
                <button type="button" mat-flat-button matDatepickerApply>Concluir</button>
              }
            </mat-datepicker-actions>
          </mat-datepicker>
          @if (getErrorMessage('payment_date')) {
            <mat-error>{{ getErrorMessage('payment_date') }}</mat-error>
          }
        </mat-form-field>
      </app-column>

      <app-column [columns]="1">
        <mat-form-field>
          <mat-label>Forma de Pagamento</mat-label>
          <mat-select formControlName="payment" required>
            @for (option of paymentOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
          @if (getErrorMessage('payment')) {
            <mat-error>{{ getErrorMessage('payment') }}</mat-error>
          }
        </mat-form-field>
      </app-column>
    </mat-tab>

    <mat-tab label="Comprovante">
      <div class="photo-container">
        <label class="photo-label">Recibo / Comprovante</label>

        @if (!photoPreview) {
          <div class="upload-box">
            <button type="button" mat-stroked-button (click)="fileInput.click()">
              <mat-icon>attach_file</mat-icon>
              Anexar Recibo
            </button>
            <input #fileInput type="file" accept="image/*" (change)="onFileSelected($event)" style="display: none" />
          </div>
        }

        @if (photoPreview) {
          <div class="preview-box">
            <img [src]="photoPreview" alt="Preview do recibo" class="img-preview" />
            <button
              type="button"
              mat-mini-fab
              color="warn"
              class="remove-btn"
              matTooltip="Remover recibo"
              (click)="removePhoto()"
            >
              <mat-icon color="warn">delete</mat-icon>
            </button>
          </div>
        }
      </div>
    </mat-tab>
  </mat-tab-group>

  <app-actions (onCancel)="handleCancel()">
    <button mat-stroked-button type="button" color="warn" (click)="handleCancel()">Cancelar</button>
    <button mat-flat-button type="submit" color="primary">
      {{ isEditMode() ? 'Atualizar' : 'Salvar' }}
    </button>
  </app-actions>
</form>
