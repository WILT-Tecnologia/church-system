<form [formGroup]="profileForm" (ngSubmit)="handleSubmit()" class="form-field-group">
  <app-column>
    <mat-slide-toggle formControlName="status" color="primary"
      >{{ profileForm.get('status')?.value ? 'Ativado' : 'Desativado' }}
    </mat-slide-toggle>
  </app-column>

  <app-column>
    <mat-form-field appearance="fill">
      <mat-label>Nome</mat-label>
      <input matInput formControlName="name" maxlength="255" required />
      <mat-error *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched"
        >{{ getErrorMessage('name') }}
      </mat-error>
    </mat-form-field>
  </app-column>

  <app-column>
    <mat-form-field appearance="fill">
      <mat-label>Descrição</mat-label>
      <textarea matInput rows="5" formControlName="description" maxlength="255"></textarea>
      <mat-error *ngIf="profileForm.get('description')?.invalid && profileForm.get('description')?.touched"
        >{{ getErrorMessage('description') }}
      </mat-error>
    </mat-form-field>
  </app-column>

  <h3>Permissões</h3>

  @if (modulesFormArray && modulesFormArray.controls.length > 0) {
    <!-- O formArrayName="modules" conecta a tabela ao FormArray no TS -->
    <table mat-table [dataSource]="modulesFormArray.controls" formArrayName="modules">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Módulo</th>
        <!-- 'control' é o FormGroup individual dentro do FormArray -->
        <td mat-cell *matCellDef="let control">
          <span>{{ control.get('module_name')?.value }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="can_read">
        <th mat-header-cell *matHeaderCellDef>Leitura</th>
        <td mat-cell *matCellDef="let control">
          <!-- Conecta o checkbox diretamente ao FormControl da linha -->
          <mat-checkbox [formControl]="control.get('can_read')"></mat-checkbox>
        </td>
      </ng-container>

      <ng-container matColumnDef="can_write">
        <th mat-header-cell *matHeaderCellDef>Escrita</th>
        <td mat-cell *matCellDef="let control">
          <mat-checkbox [formControl]="control.get('can_write')"></mat-checkbox>
        </td>
      </ng-container>

      <ng-container matColumnDef="can_delete">
        <th mat-header-cell *matHeaderCellDef>Exclusão</th>
        <td mat-cell *matCellDef="let control">
          <mat-checkbox [formControl]="control.get('can_delete')"></mat-checkbox>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <!-- Aplica [formGroupName] à linha usando o índice 'i' -->
      <tr mat-row *matRowDef="let row; columns: displayedColumns; let i = index" [formGroupName]="i"></tr>
    </table>
  } @else {
    <p>Carregando módulos ou nenhum módulo disponível...</p>
  }

  <app-actions>
    <button type="button" mat-stroked-button color="warn" (click)="handleBack()">Cancelar</button>
    <button type="submit" mat-flat-button color="primary" [disabled]="profileForm.invalid">
      {{ isEditMode ? 'Atualizar' : 'Cadastrar' }}
    </button>
  </app-actions>
</form>
