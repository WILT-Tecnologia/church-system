<form
  [formGroup]="memberForm"
  (ngSubmit)="handleSubmit()"
  class="form-field-group"
>
  <mat-tab-group preserveContent dynamicHeight [(selectedIndex)]="currentStep">
    <mat-tab label="Identificação" [disabled]="isTabDisabled(0)">
      <section class="py-4">
        <mat-card appearance="outlined">
          <mat-card-content>
            <div formGroupName="stepOne">
              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Pessoa</mat-label>
                  <input
                    type="text"
                    matInput
                    [matAutocomplete]="autoPerson"
                    [formControl]="searchControlPerson"
                    placeholder="Selecione uma pessoa"
                    (focus)="showAllPerson()"
                    required
                  />
                  <mat-autocomplete
                    #autoPerson="matAutocomplete"
                    (optionSelected)="onPersonSelected($event)"
                  >
                    <mat-option
                      *ngFor="let person of filteredPerson | async as persons"
                      [value]="person"
                    >
                      {{ person.name }}
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.person_id')?.invalid &&
                      memberForm.get('stepOne.person_id')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.person_id') }}
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Igreja</mat-label>
                  <input
                    type="text"
                    matInput
                    [matAutocomplete]="autoChurch"
                    [formControl]="searchControlChurch"
                    placeholder="Selecione uma igreja"
                    (focus)="showAllChurch()"
                    required
                  />
                  <mat-autocomplete
                    #autoChurch="matAutocomplete"
                    (optionSelected)="onChurchSelected($event)"
                  >
                    <mat-option
                      *ngFor="let church of filteredChurch | async as churches"
                      [value]="church"
                    >
                      {{ church.name }}
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.church_id')?.invalid &&
                      memberForm.get('stepOne.church_id')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.church_id') }}
                  </mat-error>
                </mat-form-field>
              </app-column>

              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>RG</mat-label>
                  <input matInput formControlName="rg" maxlength="15" />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.rg')?.invalid &&
                      memberForm.get('stepOne.rg')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.rg') }}
                  </mat-error>
                </mat-form-field>
                <mat-form-field appearance="fill">
                  <mat-label>Orgão Expedidor</mat-label>
                  <input
                    matInput
                    formControlName="issuing_body"
                    maxlength="15"
                  />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.issuing_body')?.invalid &&
                      memberForm.get('stepOne.issuing_body')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.issuing_body') }}
                  </mat-error>
                </mat-form-field>
              </app-column>

              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Estado Civil</mat-label>
                  <input
                    type="text"
                    matInput
                    [matAutocomplete]="autoCivilStatus"
                    [formControl]="searchControlCivilStatus"
                    placeholder="Selecione um estado civil"
                    (focus)="showAllCivilStatus()"
                    required
                  />
                  <mat-autocomplete
                    #autoCivilStatus="matAutocomplete"
                    (optionSelected)="onCivilStatusSelected($event)"
                  >
                    <mat-option
                      *ngFor="
                        let civilStatus of filteredCivilStatus | async;
                        civilStatus
                      "
                      [value]="civilStatus"
                    >
                      {{ civilStatus.name }}
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.civil_status_id')?.invalid &&
                      memberForm.get('stepOne.civil_status_id')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.civil_status_id') }}
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Cor/raça</mat-label>
                  <input
                    type="text"
                    matInput
                    [matAutocomplete]="autoColorRace"
                    [formControl]="searchControlColorRace"
                    placeholder="Selecione um Cor/raça"
                    (focus)="showAllColorRace()"
                    required
                  />
                  <mat-autocomplete
                    #autoColorRace="matAutocomplete"
                    (optionSelected)="onColorRaceSelected($event)"
                  >
                    <mat-option
                      *ngFor="
                        let colorRace of filteredColorRace | async;
                        colorRace
                      "
                      [value]="colorRace"
                    >
                      {{ colorRace.name }}
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.color_race_id')?.invalid &&
                      memberForm.get('stepOne.color_race_id')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.color_race_id') }}
                  </mat-error>
                </mat-form-field>
              </app-column>

              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Nacionalidade</mat-label>
                  <input matInput formControlName="nationality" />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.nationality')?.invalid &&
                      memberForm.get('stepOne.nationality')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.nationality') }}
                  </mat-error>
                </mat-form-field>
                <mat-form-field appearance="fill">
                  <mat-label>Naturalidade</mat-label>
                  <input matInput formControlName="naturalness" />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepOne.naturalness')?.invalid &&
                      memberForm.get('stepOne.naturalness')?.touched
                    "
                  >
                    {{ getErrorMessage('stepOne.naturalness') }}
                  </mat-error>
                </mat-form-field>
              </app-column>
            </div>
          </mat-card-content>
        </mat-card>
      </section>
    </mat-tab>

    <mat-tab label="Inf. complementares" [disabled]="isTabDisabled(1)">
      <section class="py-4">
        <mat-card appearance="outlined">
          <mat-card-content>
            <div formGroupName="stepTwo">
              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Formação</mat-label>
                  <input
                    type="text"
                    matInput
                    [matAutocomplete]="autoFormation"
                    [formControl]="searchControlFormations"
                    placeholder="Selecione uma formação"
                    (focus)="showAllFormations()"
                    required
                  />
                  <mat-autocomplete
                    #autoFormation="matAutocomplete"
                    (optionSelected)="onFormationsSelected($event)"
                  >
                    <mat-option
                      *ngFor="
                        let formation of filteredFormations | async;
                        formations
                      "
                      [value]="formation"
                    >
                      {{ formation.name }}
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error
                    *ngIf="
                      memberForm.get('stepTwo.formation_id')?.invalid &&
                      memberForm.get('stepTwo.formation_id')?.touched
                    "
                  >
                    {{ getErrorMessage('stepTwo.formation_id') }}
                  </mat-error>
                </mat-form-field>
                <mat-form-field *ngIf="isFormationCourseVisible">
                  <mat-label>Curso de Formação</mat-label>
                  <input matInput formControlName="formation_course" />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepTwo.formation_course')?.invalid &&
                      memberForm.get('stepTwo.formation_course')?.touched
                    "
                  >
                    {{ getErrorMessage('stepTwo.formation_course') }}
                  </mat-error>
                </mat-form-field>
              </app-column>

              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Profissão</mat-label>
                  <input matInput formControlName="profission" />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepTwo.profission')?.invalid &&
                      memberForm.get('stepTwo.profission')?.touched
                    "
                  >
                    {{ getErrorMessage('stepTwo.profission') }}
                  </mat-error>
                </mat-form-field>
              </app-column>

              <div class="inputs checkbox-column" style="max-width: 30rem">
                <mat-label>Deficiências</mat-label>
                <div class="checkbox-group">
                  <div class="checkbox-column">
                    <mat-checkbox color="primary" formControlName="def_hearing"
                      >Auditiva</mat-checkbox
                    >
                    <mat-checkbox color="primary" formControlName="def_visual"
                      >Visual</mat-checkbox
                    >
                    <mat-checkbox color="primary" formControlName="def_physical"
                      >Física</mat-checkbox
                    >
                    <mat-checkbox color="primary" formControlName="def_other"
                      >Outra</mat-checkbox
                    >
                  </div>
                  <div class="checkbox-column">
                    <mat-checkbox color="primary" formControlName="def_mental"
                      >Mental</mat-checkbox
                    >
                    <mat-checkbox
                      color="primary"
                      formControlName="def_intellectual"
                      >Intelectual</mat-checkbox
                    >
                    <mat-checkbox color="primary" formControlName="def_multiple"
                      >Múltipla</mat-checkbox
                    >
                  </div>
                </div>
                <mat-form-field
                  appearance="fill"
                  *ngIf="memberForm.get('stepTwo.def_other')?.value"
                >
                  <mat-label>Descrição da Outra Deficiência</mat-label>
                  <textarea
                    matInput
                    rows="4"
                    formControlName="def_other_description"
                    matTextareaAutosize
                  ></textarea>
                  <mat-error
                    *ngIf="
                      memberForm.get('stepTwo.def_other_description')
                        ?.invalid &&
                      memberForm.get('stepTwo.def_other_description')?.touched
                    "
                  >
                    {{ getErrorMessage('stepTwo.def_other_description') }}
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </section>
    </mat-tab>

    <mat-tab label="Inf. espirituais" [disabled]="isTabDisabled(2)">
      <section class="py-4">
        <mat-card appearance="outlined">
          <mat-card-content>
            <div formGroupName="stepThree">
              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Data do batismo</mat-label>
                  <input
                    matInput
                    [matDatepicker]="baptismPicker"
                    name="birth_date"
                    [min]="minDate"
                    [max]="maxDate"
                    placeholder="Selecione uma data"
                    formControlName="baptism_date"
                    (focus)="openCalendarBaptismDate()"
                    readonly
                  />
                  @if (memberForm.value.stepThree.baptism_date) {
                    <button
                      type="button"
                      mat-icon-button
                      matSuffix
                      (click)="clearDate('stepThree.baptism_date')"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                  } @else {
                    <ng-container>
                      <mat-datepicker-toggle
                        matSuffix
                        [for]="baptism_date"
                      ></mat-datepicker-toggle>
                      <mat-datepicker #baptism_date>
                        <mat-datepicker-actions>
                          <button
                            mat-stroked-button
                            type="button"
                            color="warn"
                            matDatepickerCancel
                          >
                            Cancelar
                          </button>
                          <button
                            mat-raised-button
                            type="button"
                            color="primary"
                            matDatepickerApply
                          >
                            Confirmar
                          </button>
                        </mat-datepicker-actions>
                      </mat-datepicker>
                    </ng-container>
                  }
                  <mat-error
                    *ngIf="
                      memberForm.get('stepThree.baptism_date')?.invalid &&
                      memberForm.get('stepThree.baptism_date')?.touched
                    "
                  >
                    {{ getErrorMessage('stepThree.baptism_date') }}
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Oficial do batismo</mat-label>
                  <input matInput formControlName="baptism_official" />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepThree.baptism_official')?.invalid &&
                      memberForm.get('stepThree.baptism_official')?.touched
                    "
                    >{{
                      getErrorMessage('stepThree.baptism_official')
                    }}</mat-error
                  >
                </mat-form-field>
              </app-column>
              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Local do batismo</mat-label>
                  <input matInput formControlName="baptism_locale" />
                  <mat-error
                    *ngIf="
                      memberForm.get('stepThree.baptism_locale')?.invalid &&
                      memberForm.get('stepThree.baptism_locale')?.touched
                    "
                    >{{
                      getErrorMessage('stepThree.baptism_locale')
                    }}</mat-error
                  >
                </mat-form-field>
              </app-column>

              <app-column>
                <div class="w-80">
                  <mat-checkbox
                    color="primary"
                    formControlName="baptism_holy_spirit"
                    (change)="
                      onCheckboxChange(
                        'stepThree.baptism_holy_spirit_date',
                        'stepThree.baptism_holy_spirit'
                      )
                    "
                  >
                    Batizado pelo Espírito Santo?
                  </mat-checkbox>
                </div>
                @if (memberForm.get('stepThree.baptism_holy_spirit')?.value) {
                  <mat-form-field class="w-6/12 lg:w-full" appearance="fill">
                    <mat-label>Data do batismo do Espírito Santo</mat-label>
                    <input
                      matInput
                      [matDatepicker]="baptismHolySpiritPicker"
                      [min]="minDate"
                      [max]="maxDate"
                      name="baptism_holy_spirit_date"
                      placeholder="Selecione uma data"
                      formControlName="baptism_holy_spirit_date"
                      (focus)="openCalendarBaptismHolySpiritDate()"
                      readonly
                    />
                    @if (memberForm.value.stepThree.baptism_holy_spirit_date) {
                      <button
                        type="button"
                        mat-icon-button
                        matSuffix
                        (click)="
                          clearDate('stepThree.baptism_holy_spirit_date')
                        "
                      >
                        <mat-icon>close</mat-icon>
                      </button>
                    } @else {
                      <ng-container>
                        <mat-datepicker-toggle
                          matSuffix
                          [for]="baptism_holy_spirit_date"
                        ></mat-datepicker-toggle>
                        <mat-datepicker #baptism_holy_spirit_date>
                          <mat-datepicker-actions>
                            <button
                              mat-stroked-button
                              type="button"
                              color="warn"
                              matDatepickerCancel
                            >
                              Cancelar
                            </button>
                            <button
                              mat-raised-button
                              type="button"
                              color="primary"
                              matDatepickerApply
                            >
                              Confirmar
                            </button>
                          </mat-datepicker-actions>
                        </mat-datepicker>
                      </ng-container>
                    }
                    @if (
                      memberForm.get('stepThree.baptism_holy_spirit_date')
                        ?.invalid &&
                      memberForm.get('stepThree.baptism_holy_spirit_date')
                        ?.touched
                    ) {
                      <mat-error>
                        {{
                          getErrorMessage('stepThree.baptism_holy_spirit_date')
                        }}
                      </mat-error>
                    }
                  </mat-form-field>
                }
              </app-column>

              <app-column>
                <mat-form-field appearance="fill">
                  <mat-label>Data da recepção</mat-label>
                  <input
                    matInput
                    name="receipt_date"
                    [min]="minDate"
                    [max]="maxDate"
                    placeholder="Selecione uma data"
                    [matDatepicker]="receiptDatePicker"
                    formControlName="receipt_date"
                    (focus)="openCalendarReceiptDate()"
                    readonly
                  />
                  @if (memberForm.value.stepThree.receipt_date) {
                    <button
                      type="button"
                      mat-icon-button
                      matSuffix
                      (click)="clearDate('stepThree.receipt_date')"
                    >
                      <mat-icon>close</mat-icon>
                    </button>
                  } @else {
                    <ng-container>
                      <mat-datepicker-toggle
                        matSuffix
                        [for]="receipt_date"
                      ></mat-datepicker-toggle>
                      <mat-datepicker #receipt_date>
                        <mat-datepicker-actions>
                          <button
                            mat-stroked-button
                            type="button"
                            color="warn"
                            matDatepickerCancel
                          >
                            Cancelar
                          </button>
                          <button
                            mat-raised-button
                            type="button"
                            color="primary"
                            matDatepickerApply
                          >
                            Confirmar
                          </button>
                        </mat-datepicker-actions>
                      </mat-datepicker>
                    </ng-container>
                  }
                  @if (
                    memberForm.get('stepThree.receipt_date')?.invalid &&
                    memberForm.get('stepThree.receipt_date')?.touched
                  ) {
                    <mat-error>
                      {{ getErrorMessage('stepThree.receipt_date') }}
                    </mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Origem do membro</mat-label>
                  <input
                    type="text"
                    matInput
                    [matAutocomplete]="autoMemberOrigin"
                    [formControl]="searchControlMemberOrigins"
                    placeholder="Selecione uma origem do membro"
                    (focus)="showAllMemberOrigins()"
                    required
                  />
                  <mat-autocomplete
                    #autoMemberOrigin="matAutocomplete"
                    (optionSelected)="onMemberOriginSelected($event)"
                  >
                    <mat-option
                      *ngFor="
                        let memberOrigin of filterMemberOrigins | async;
                        memberOrigin
                      "
                      [value]="memberOrigin"
                    >
                      {{ memberOrigin.name }}
                    </mat-option>
                  </mat-autocomplete>
                  <mat-error
                    *ngIf="
                      memberForm.get('stepThree.member_origin_id')?.invalid &&
                      memberForm.get('stepThree.member_origin_id')?.touched
                    "
                  >
                    {{ getErrorMessage('stepThree.member_origin_id') }}
                  </mat-error>
                </mat-form-field>
              </app-column>
            </div>
          </mat-card-content>
        </mat-card>
      </section>
    </mat-tab>

    <ng-container *ngIf="isEditMode">
      <mat-tab label="Filiação">
        <div formGroupName="stepFour">
          <app-families [families]="families"></app-families>
        </div>
      </mat-tab>
      <mat-tab label="Ordenação">
        <div formGroupName="stepFive">
          <app-ordinations [ordination]="ordinations"></app-ordinations>
        </div>
      </mat-tab>
      <mat-tab label="Situação">
        <div formGroupName="stepSix">
          <app-status-member [statusMember]="statusMember"></app-status-member>
        </div>
      </mat-tab>
    </ng-container>
  </mat-tab-group>

  <mat-divider></mat-divider>
  <app-actions>
    <button mat-stroked-button color="warn" type="button" (click)="onBack()">
      {{ currentStep === 0 ? 'Cancelar' : 'Voltar' }}
    </button>
    <ng-container *ngIf="isEditMode">
      <button
        mat-raised-button
        (click)="onNext()"
        type="button"
        color="primary"
        [disabled]="memberForm.get('step' + currentStep + 1)?.valid"
        *ngIf="currentStep < 5"
      >
        Avançar
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        *ngIf="currentStep === 5"
        [disabled]="memberForm.invalid || !canProceedToNextStep()"
      >
        {{ isEditMode ? 'Atualizar' : 'Cadastrar' }}
      </button>
      @if (currentStep !== 5) {
        <button
          mat-stroked-button
          color="primary"
          type="submit"
          (click)="handleUpdateWithoutClosing()"
          [disabled]="memberForm.invalid"
        >
          Atualizar
        </button>
      }
    </ng-container>
    <ng-container *ngIf="!isEditMode">
      <button
        mat-raised-button
        (click)="onNext()"
        type="button"
        color="primary"
        [disabled]="!canProceedToNextStep()"
        *ngIf="currentStep < 2"
      >
        Avançar
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        (click)="finalizeStepThree()"
        [disabled]="memberForm.invalid"
        *ngIf="currentStep === 2"
      >
        Cadastrar
      </button>
    </ng-container>
  </app-actions>
</form>
